--- PROJECT SUMMARY ---
SecuredCalling is a Flutter multi-platform voice meeting application built on Agora RTC and Firebase (Auth, Firestore, Cloud Functions, FCM). Users can create and join meetings, with host controls (mute/unmute, approvals), speaker focus, and member/admin features. A new isolated webinar flow adds roles (Host/SubHost/Participant) enforcing one-way listening for participants and controlled speaking permissions, plus an optional private 1:1 call between host/subhost and an approved participant that returns users to the original meeting.

User roles: Admin, Member (host capability), User/Participant, Host/SubHost (in-meeting roles).
Platforms in scope: Android, iOS, Web (desktop platforms exist in repo but are out-of-scope for rebuild).


--- THEME & UI TOKENS (EXTRACTED) ---
Source: lib/core/theme/app_theme.dart (lines 1-322)
- Colors (hex):
  - primaryColor: #4A6CFA
  - secondaryColor: #32B5FF
  - accentColor: #01C58C
  - errorColor: #E53935
  - warningColor: #FFAB40
  - successColor: #43A047
  - lightBackgroundColor: #FFFFFF
  - lightSurfaceColor: #F5F7FA
  - lightTextColor: #202124
  - lightSecondaryTextColor: #5F6368
  - darkBackgroundColor: #121212
  - darkSurfaceColor: #1E1E1E
  - darkTextColor: #E8EAED
  - darkSecondaryTextColor: #AEAEAE
- Gradients: primaryGradient [primaryColor, secondaryColor]
- Typography (GoogleFonts): Inter and Montserrat
  - displayLarge/Medium/Small: Montserrat, bold, sizes 32/28/24
  - titleLarge/Medium/Small: Inter, weight 600, sizes 20/18/16
  - bodyLarge: Inter 16, bodyMedium: Inter 14, bodySmall: Inter 12 (secondary)
- Components:
  - AppBarTheme (light/dark): elevation 0, centered title
  - Elevated/Outlined/TextButton: rounded radius 10, primary backgrounds
  - InputDecorationTheme: filled, radius 12, focused border primary, error border errorColor
  - CardTheme: radius 16, elevation 0
  - DividerTheme: light #E0E0E0; dark #3D3D3D
  - FAB: primary bg, white fg
  - BottomNavigationBar: fixed, primary selected
  - BottomSheet/Dialog: rounded top 20
- Fonts: via google_fonts; no custom font assets declared.
- Global components reflecting tokens: form fields use InputDecorationTheme; buttons use theme.


--- ASSETS & ICONS ---
Local assets:
- assets/lottie/ripple.json (speaking animation)
- assets/sounds/join_sound.mp3 (join sound)
iOS icons:
- ios/Runner/Assets.xcassets/AppIcon.appiconset/* (app icons)
Web assets:
- Uses Material Icons via Flutter; no additional web-specific assets defined.
Remote assets/CDN: none detected.


--- SCREEN & NAVIGATION INVENTORY ---
Routes: lib/core/routes/app_router.dart (lines 1-56)
- Screen: WelcomeScreen
  - Route: /welcome
  - Path: lib/features/welcome/views/welcome_screen.dart
  - Purpose: Entry screen; navigates to auth/home.
  - Inputs/Outputs: none; navigation side-effects only.
  - State: minimal
  - Priority: MUST

- Screen: LoginRegisterScreen
  - Route: /auth
  - Path: lib/features/auth/views/login_register_screen.dart
  - Key widgets: LoginForm (lib/features/auth/views/login_screen.dart), RegisterForm (lib/features/auth/views/register_screen.dart)
  - Purpose: Email/password auth with member code, password reset
  - Inputs: none; Outputs: login success -> /home
  - State: LoginRegisterController (GetX)
  - Priority: MUST

- Screen: HomeScreen
  - Route: /home
  - Path: lib/features/home/views/home_screen.dart (lines 1-395)
  - Key widgets: MembarTabViewWidget, UserTab; meeting create/join entry points
  - Purpose: Dashboard; create/join meetings; admin/users navigation
  - Inputs: none; Outputs: navigations to meeting, admin, users
  - State: TabController; AppLocalStorage user
  - Priority: MUST

- Screen: AgoraMeetingRoom (legacy meeting)
  - Route: /meeting
  - Path: lib/features/meeting/views/agora_meeting_room.dart (lines 1-543)
  - Key widgets: grid participants, speaker ripple, control buttons
  - Purpose: Legacy meeting room with host/participant controls
  - Inputs: {channelName: String, isHost: bool, meetingId: String}
  - Outputs: end/leave meeting navigation
  - State: MeetingController (GetX)
  - Priority: MUST

- Screen: ViewAllMeetingList
  - Route: /meeting/view_all
  - Path: lib/features/home/views/view_all_meeting_list.dart
  - Purpose: Show list of meetings
  - Inputs: List<MeetingModel>
  - Priority: NICE-TO-HAVE

Webinar flow (component entry rather than route):
- WebinarEntryPage
  - Path: lib/webinar/views/webinar_entry.dart (lines 1-78)
  - Purpose: Chooses HostView/SubHostView/ParticipantView based on role
  - Inputs: appId, functionsBaseUrl, roomId, channelName, selfUser
  - Priority: MUST (for webinar)
- HostView/SubHostView/ParticipantView
  - Paths: lib/webinar/views/host_view.dart, subhost_view.dart, participant_view.dart
  - Purpose: Webinar UI (paged grid, menus, private call accept/end, mutes)
  - Inputs: WebinarMeetingController
  - Priority: MUST (for webinar)

Flattened nav map:
- /welcome -> /auth or /home
- /auth -> /home
- /home -> legacy /meeting (with args) OR WebinarEntryPage (runtime switch)
- WebinarEntryPage -> Host/SubHost/Participant internal views


--- UI COMPONENTS LIBRARY (REUSEABLE WIDGETS) ---
- AppTextFormField
  - Path: lib/widgets/app_text_form_widget.dart
  - Props: controller, labelText, type (enum), validator, isPasswordRequired?
  - Responsibility: Styled input with validation; UI only
  - Refactor API (proposed): {controller, label, inputType, helperText?, validator?}

- WaterRipple
  - Path: lib/widgets/speaker_ripple_effect.dart (lines 1-69)
  - Props: color
  - Responsibility: Visual ripple animation behind speaking user
  - Refactor API: {color}

- NameTile (webinar)
  - Path: lib/webinar/views/common_widgets.dart
  - Props: name, isSpeaking, isMicMuted
  - Responsibility: Unified participant tile with ripple on speaking
  - Refactor API: {name: String, isSpeaking: bool, micState: enum}

Widgets mixing UI + logic (flag for refactor):
- Legacy meeting UI directly calls MeetingController actions in menu/callbacks; prefer binding via ViewModel outputs.
- Auth forms toggle controller state; acceptable but can be decoupled further.


--- FEATURES / FUNCTIONALITY (DETAILED) ---
Feature: Authentication (CORE)
- Flow: Register (member code), create Firestore user, send email verification -> login -> cache user (SharedPreferences) -> navigate home
- Screens: LoginRegisterScreen, LoginForm, RegisterForm
- APIs: Firebase Auth; Firestore users
- Background: none; email verification prompt
- Platform: none special

Feature: Meeting create/join (CORE)
- Create Flow: Bottom sheet -> Firestore meetings doc -> if instant, navigate meeting; else scheduled message
- Join Flow: Search meet ID (and password) -> if requires approval, send request and await host approval -> navigate meeting on approval
- Screens: HomeScreen, JoinMeetingDialog
- APIs: Firestore meetings; token fetch; participants arrays
- Background: Meeting timer for timeouts and extension prompts
- Platform: Microphone permission and notifications

Feature: Legacy meeting room (CORE)
- Controls: Host mute/unmute, revoke speaking; participants request to speak
- Audio: Live broadcasting; host mutes remote for unapproved speakers
- Files: lib/features/meeting/views/agora_meeting_room.dart; lib/features/meeting/bindings/live_meeting_controller.dart; lib/features/meeting/services/agora_service.dart

Feature: Webinar meeting (CORE)
- Roles: Host/SubHost hear everyone; Participants hear only Host/SubHost
- Speaking: Participants cannot speak unless approved; when approved, only Host/SubHost hear them (participants remain mutually muted)
- Private 1:1: Host/SubHost may invite an approved participant to a private channel (both broadcasters); leaving re-joins original meeting with defaults (Host/SubHost broadcasters; Participant audience)
- Signaling (Firestore): request_to_speak, approve_speak, revoke_speak, promote_to_subhost, demote_to_participant, kick_user, mic_status_update, start_private_call, end_private_call
- UI: Host/SubHost paged grid (6 tiles/screen), tile menus; Participant shows Host/SubHost + self with request/mic/speaker/end buttons; accept/end private call buttons
- Files: lib/webinar/models/webinar_user_model.dart; lib/webinar/services/webinar_meeting_service.dart; lib/webinar/controllers/webinar_meeting_controller.dart; lib/webinar/views/*; lib/webinar/utils/webinar_meeting_util.dart

Feature: Admin/Member (CORE)
- Admin screens exist (user/member management, reminders). Keep in scope; map to MVVM repos/datasources.

Feature: Notifications (OPTIONAL)
- Local + FCM setup; notification channel; permission prompt


--- API & BACKEND INTERACTIONS ---
Base URL storage: Use Firebase Remote Config (FUNCTIONS_BASE_URL) at runtime instead of hard-coded.
Token endpoint (Functions): functions/index.js
- GET /generateToken
  - Query: channelName (string, required), uid (number), user_role ("0"=subscriber, "1"=publisher)
  - Response: { token: string }
  - Auth: none (recommend restricting via Callable or auth check in production)

Notification endpoint (Functions):
- POST /sendNotification
  - Body: { fcmToken: string, title: string, body: string, data?: object }
  - Response: { success: boolean, response?: any }

Agora RTC (client):
- ChannelProfile: LIVE_BROADCASTING
- Roles: clientRoleBroadcaster/clientRoleAudience
- Volume indication: interval=200ms, smooth=3, VAD enabled

Webinar Signaling (Firestore):
- Path: webinarRooms/{roomId}/signals (ordered by createdAt)
- Message: { type, fromUserId, toUserId?, payload?, createdAt }
- Members at webinarRooms/{roomId}/members/{userId}: WebinarUserModel map

Legacy Meetings (Firestore):
- Path: meetings/{meetingId}
- Fields: hostId, hostUserId, hostName, meet_id, meetingName, channelName, maxParticipants, password, duration, scheduledStartTime, scheduledEndTime, requiresApproval, status, participants[], pendingApprovals[], speakRequests[], approvedSpeakers[], tokens map (per uid: { token, expiry_time })

Ambiguities captured:
- Earlier code used userRole vs user_role; rebuild standardizes on user_role everywhere.


--- LOCAL DATA & STORAGE ---
SharedPreferences: lib/core/services/app_local_storage.dart (lines 10-61)
- Keys: user-details (AppUser JSON), is-user-logged-in (bool)
- storeUserDetails, getUserDetails, setLoggedIn, signOut

Token caching (Firestore): lib/core/services/http_service.dart
- meetings/{meetingId}.tokens[uid] = { token, expiry_time }

Remote Config (proposed; to implement in rebuild):
- Keys:
  - FUNCTIONS_BASE_URL: string (e.g., https://us-central1-…/api)
  - AGORA_APP_ID: string
  - WEBINAR_ENABLED: bool
  - ENV: string (dev|staging|prod)
- Load at app startup before DI wiring; inject into repositories/data sources.


--- PACKAGE & NATIVE DEPENDENCIES ---
pubspec.yaml (selected):
- State mgmt: get ^4.7.2
- Firebase: firebase_core ^3.12.1, firebase_auth ^5.5.1, cloud_firestore ^5.6.5, cloud_functions ^5.5.1, firebase_messaging ^15.2.6
- RTC: agora_rtc_engine ^6.5.1
- Storage: shared_preferences ^2.5.3
- UI: google_fonts, lottie, cupertino_icons
- Permissions: permission_handler ^12.0.0+1
- Notifications: flutter_local_notifications ^19.2.1
- Networking: http ^1.4.0

Native configs:
- Android manifest: android/app/src/main/AndroidManifest.xml (permissions: INTERNET, RECORD_AUDIO, CAMERA, MODIFY_AUDIO_SETTINGS, ACCESS_NETWORK/WIFI, POST_NOTIFICATIONS, BLUETOOTH/CONNECT)
- iOS Info.plist: ios/Runner/Info.plist (ensure NSMicrophoneUsageDescription in rebuild)
- Firebase options: lib/firebase_options.dart (keys present; move to secure env for rebuild)
- Agora App ID: hard-coded in lib/features/meeting/services/agora_service.dart (line 11); move to Remote Config

Minimal dependency set (rebuild): get, firebase_core/auth/firestore/functions/messaging, shared_preferences, http, permission_handler, flutter_local_notifications, google_fonts, agora_rtc_engine


--- ARCHITECTURE TRANSFORMATION PLAN (MVVM + GetX) ---
Proposed structure:
- lib/core/
  - models/ (AppUser, Meeting, Member, Participant, etc.)
  - services/ (wrappers if any), utils/, theme/, routes/
  - config/remote_config_service.dart (load Remote Config)
- lib/features/auth/
  - data/ (AuthRemoteDataSource -> FirebaseAuth, UsersDataSource -> Firestore)
  - domain/ (AuthRepository)
  - presentation/ (views, view_models/LoginViewModel)
- lib/features/meeting/
  - data/ (MeetingRemoteDataSource -> Firestore, AgoraDataSource -> RTC, TokenDataSource -> Functions)
  - domain/ (MeetingRepository)
  - presentation/ (views/MeetingRoom, view_models/MeetingViewModel)
- lib/features/webinar/
  - data/ (WebinarRemoteDataSource -> Firestore signaling, reuse AgoraDataSource)
  - domain/ (WebinarRepository)
  - presentation/ (views, view_models/WebinarViewModel)
- lib/app/ (GetMaterialApp wiring)

Mapping current -> MVVM:
- AppFirebaseService -> MeetingRepository + UsersRepository + AuthRepository (split) with corresponding DataSources
- AppHttpService -> TokenDataSource (Functions)
- AgoraService -> AgoraDataSource
- MeetingController -> MeetingViewModel
- WebinarMeetingService -> WebinarRepository + AgoraDataSource
- WebinarMeetingController -> WebinarViewModel

Example skeletons:
JSON/YAML pseudo interfaces
Repository:
{
  "MeetingRepository": {
    "create(meeting)": "Future<String>",
    "watch(meetingId)": "Stream<Meeting>",
    "approveJoin(meetingId,userId)": "Future<void>",
    "getToken(channel, uid, role)": "Future<String>"
  }
}

ViewModel (GetX):
{
  "MeetingViewModel": {
    "state": {"isLoading": "RxBool", "participants": "RxList", "isMuted": "RxBool"},
    "actions": ["createMeeting", "join", "toggleMute", "leave"],
    "deps": ["MeetingRepository", "AgoraDataSource"]
  }
}

Dependency injection:
- Use Bindings per feature: Get.lazyPut for repositories/data sources/view models
- Initial binding loads Remote Config, then injects base URLs and AGORA_APP_ID


--- CLEANUP & OPTIMIZATION CHECKLIST ---
Remove/Refactor:
- Hard-coded Agora App ID -> Remote Config
- Unify user_role param name in client and server
- Reduce UI-business coupling in legacy meeting view

Performance:
- Minimize rebuilds in meeting room; prefer Obx granularity and const widgets
- Ensure grids are paginated/lazy (webinar already pages by six)

Security:
- Remove API keys from source control; use Remote Config/CI secrets
- Consider migrating token endpoint to Callable with auth


--- BUILD, SIGNING & CI/CD ---
Current:
- No explicit flavors; default Firebase config present
Plan:
- Platforms: Android, iOS, Web
- Add GitHub Actions: flutter test, build (apk/ipa/web), cache pub/gradle, optional Firebase App Distribution
- Android signing: configure in android/app/build.gradle; keep keystore out of repo
- iOS signing: Xcode-managed; Fastlane recommended


--- TESTS & QA ---
Existing:
- Minimal RunnerTests; no Dart tests detected
Recommended tests:
- Unit: AuthRepository, MeetingRepository, WebinarRepository (signals, routing)
- Widget: Login/Register forms validation; JoinMeetingDialog; Webinar tile menus
- Integration: Token fetch + join channel (mock http/agora), Firestore signaling flows
Sample cases:
- Approve speak -> participant role switches to broadcaster locally; other participants still muted
- Private call invite/accept/end -> return to main with defaults and policy reapplied


--- RUN & DEV SETUP (EXACT) ---
Prerequisites:
- Flutter SDK; Android/iOS toolchains; Firebase CLI for functions (optional)
Commands:
- flutter pub get
- flutter run -d <android|ios|chrome>
- Build Android: flutter build apk --release
- Build iOS: flutter build ios --release (set signing)
- Build Web: flutter build web
Environment/Config:
- Ensure GoogleService files exist (android/app/google-services.json; ios/Runner/GoogleService-Info.plist)
- On app start: Initialize Firebase, fetch/activate Remote Config (FUNCTIONS_BASE_URL, AGORA_APP_ID, WEBINAR_ENABLED)


--- SAMPLE DATA & MIGRATION ---
Meetings (Firestore):
{ "hostId":"firebaseUid", "hostUserId":1234, "hostName":"Alice", "meetingName":"Daily", "channelName":"MEET1234", "maxParticipants":45, "requiresApproval":true, "duration":60, "status":"live", "participants":[1234,5678], "pendingApprovals":[], "speakRequests":[], "approvedSpeakers":[], "tokens": { "1234": { "token":"agora..", "expiry_time": 1730000000000 } } }

Webinar (Firestore):
- webinarRooms/{roomId}: { roomId, channelName, hostId, createdAt }
- webinarRooms/{roomId}/members/{userId}: { userId, agoraUid, displayName, role:"HOST|SUBHOST|PARTICIPANT", isMicMuted, canSpeak, isKicked, updatedAt }
- webinarRooms/{roomId}/signals/{autoId}: { type, fromUserId, toUserId?, payload?, createdAt }

Migration:
- Move secrets (Agora App ID, base URL) to Remote Config
- Standardize token endpoint param to user_role
- Split AppFirebaseService into repositories/data sources


--- FILE REFERENCES & TODOs ---
Authoritative files:
- Theme: lib/core/theme/app_theme.dart (1-322)
- Routes: lib/core/routes/app_router.dart (1-56)
- App init: lib/main.dart (1-12), lib/app/app.dart (1-23)
- Legacy meeting: lib/features/meeting/views/agora_meeting_room.dart (1-543); lib/features/meeting/bindings/live_meeting_controller.dart (1-690); lib/features/meeting/services/agora_service.dart (1-118)
- Webinar module: lib/webinar/models/webinar_user_model.dart; lib/webinar/services/webinar_meeting_service.dart; lib/webinar/controllers/webinar_meeting_controller.dart; lib/webinar/views/*; lib/webinar/utils/webinar_meeting_util.dart
- Create/Join flows: lib/features/home/views/meeting_util_service.dart (1-387); lib/features/meeting/views/join_meeting_dialog.dart (1-365)
- Firebase services: lib/core/services/app_firebase_service.dart (1-619)
- Token HTTP: lib/core/services/http_service.dart (1-170)
- Notifications: lib/core/services/notification_service.dart (1-104)
- Permissions: lib/core/services/permission_service.dart (1-112)
- Local storage: lib/core/services/app_local_storage.dart (1-61)
- Functions: functions/index.js (1-63)

TODOs:
- P0: Replace hard-coded Agora App ID with Remote Config
- P0: Align token endpoint param to user_role in both client/server
- P0: Extract MeetingController logic into ViewModel + Repository
- P1: Add Remote Config bootstrap and DI wiring
- P1: Add tests for webinar signaling and audio routing
- P2: Consolidate duplicate widgets; reduce rebuilds


--- ESTIMATED EFFORT (OPTIONAL) ---
- MVVM refactor (auth, meeting, webinar): medium ~ 14–20 person-days
- Remote Config integration + DI: small ~ 2–4 person-days
- Tests (unit/widget/integration): medium ~ 6–10 person-days


Questions for devs:
1) Confirm that only Android/iOS/Web are required for the rebuild (desktop excluded).
2) Should the webinar flow become a first-class route (/webinar) or remain an entry widget with runtime switch?
3) Are admin/member features all in scope for phase 1 of the rebuild (list any deprecations)?
4) Any environment-specific FUNCTIONS_BASE_URL/AGORA_APP_ID variants (dev/staging/prod) to seed in Remote Config?
5) Is token endpoint authentication required (Callable + auth) or remain public GET for now?


